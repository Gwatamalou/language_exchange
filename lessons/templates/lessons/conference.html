{% extends 'base.html' %}

{% block content %}

<div class="container d-flex flex-column align-items-center justify-content-center vh-100 my-5">
    <!-- –í–∏–¥–µ–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ -->
    <div class="position-relative mb-4" style="width: 100%; max-width: 800px; aspect-ratio: 16/9; background-color: #999999; border-radius: 10px; overflow: hidden;">
        <video id="remoteVideo" autoplay style="width: 100%; height: 100%; object-fit: cover;"></video>

        <!-- –õ–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ -->
        <div class="position-absolute bottom-0 start-0 p-2">
            <video id="localVideo" autoplay muted class="rounded-circle border" style="width: 100px; height: 100px; object-fit: cover; background: #53B3FF;"></video>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ "–ó–∞–∫–æ–Ω—á–∏—Ç—å" -->
        <button id="end-chat" class="btn btn-danger rounded-circle position-absolute bottom-0 end-0 m-3" style="width: 50px; height: 50px;">
            &#10005;
        </button>

        <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∏–¥–µ–æ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–º -->
        <div class="d-flex justify-content-center position-absolute bottom-0 start-50 translate-middle-x mb-3">
            <button id="toggle-video" class="btn btn-secondary rounded-circle me-3" style="width: 50px; height: 50px;">
                üé•
            </button>
            <button id="toggle-audio" class="btn btn-secondary rounded-circle" style="width: 50px; height: 50px;">
                üé§
            </button>
        </div>
    </div>

    <!-- –ß–∞—Ç -->
    <div class="chat-container bg-light border rounded p-3" style="width: 100%; max-width: 600px; height: 300px; overflow-y: auto; display: flex; flex-direction: column-reverse;">
        <div id="chat-log" class="chat-log">
            <!-- –°–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ -->
        </div>
    </div>

    <!-- –ü–æ–ª—è –≤–≤–æ–¥–∞ –∏ –∫–Ω–æ–ø–∫–∞ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å" -->
    <div class="d-flex mt-3" style="width: 100%; max-width: 600px;">
        <input id="chat-message-input" type="text" class="form-control me-2" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">
        <button id="chat-message-submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
</div>

<script>
  const roomName = "{{ room_name }}";
const username = "{{ request.user.username }}";
const chatSocket = new WebSocket(
    'ws://' + window.location.host + '/ws/chat/' + roomName + '/'
);

const localVideo = document.getElementById('localVideo');
const remoteVideo = document.getElementById('remoteVideo');
const toggleVideoButton = document.getElementById('toggle-video');
const toggleAudioButton = document.getElementById('toggle-audio');
let localStream;

let peerConnection;
const configuration = {
    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –≤–∏–¥–µ–æ
async function startLocalVideo() {
    try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;
        createPeerConnection();
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–µ–¥–∏–∞-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º:", error);
    }
}

// –°–æ–∑–¥–∞–Ω–∏–µ RTCPeerConnection
function createPeerConnection() {
    peerConnection = new RTCPeerConnection(configuration);

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–∫–æ–≤ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å—Ç—Ä–∏–º–∞
    localStream.getTracks().forEach(track => {
        peerConnection.addTrack(track, localStream);
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ —Ç—Ä–µ–∫–∞
    peerConnection.ontrack = (event) => {
        if (event.streams && event.streams[0]) {
            console.log("–ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª—ë–Ω–Ω—ã–π –ø–æ—Ç–æ–∫:", event.streams[0]);
            remoteVideo.srcObject = event.streams[0];
        } else {
            console.warn("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤ –≤ ontrack.");
        }
    };

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ ICE-–∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
    peerConnection.onicecandidate = (event) => {
        if (event.candidate) {
            chatSocket.send(JSON.stringify({
                'ice': event.candidate,
                'username': username
            }));
        }
    };

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    peerConnection.onconnectionstatechange = () => {
        console.log("Connection state:", peerConnection.connectionState);
        if (peerConnection.connectionState === "failed") {
            console.error("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ WebRTC –Ω–µ —É–¥–∞–ª–æ—Å—å.");
        }
    };

    peerConnection.oniceconnectionstatechange = () => {
        console.log("ICE state:", peerConnection.iceConnectionState);
    };
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–µ–æ
toggleVideoButton.onclick = () => {
    const videoTrack = localStream.getVideoTracks()[0];
    if (videoTrack) {
        videoTrack.enabled = !videoTrack.enabled;
        toggleVideoButton.classList.toggle('btn-danger');
    }
};

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∞—É–¥–∏–æ
toggleAudioButton.onclick = () => {
    const audioTrack = localStream.getAudioTracks()[0];
    if (audioTrack) {
        audioTrack.enabled = !audioTrack.enabled;
        toggleAudioButton.classList.toggle('btn-danger');
    }
};

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π WebSocket
chatSocket.onmessage = async function (e) {
    const data = JSON.parse(e.data);

    if (data.sdp) {
        console.log("–ü–æ–ª—É—á–µ–Ω SDP:", data.sdp.type);
        await handleSDP(data.sdp);
    } else if (data.ice) {
        console.log("–ü–æ–ª—É—á–µ–Ω ICE-–∫–∞–Ω–¥–∏–¥–∞—Ç:", data.ice);
        await handleICE(data.ice);
    } else if (data.message) {
        const chatLog = document.querySelector('#chat-log');
        const messageElement = document.createElement('div');

        messageElement.className = data.username === username ? 'text-end text-primary' : 'text-start text-secondary';
        messageElement.innerHTML = `<b>${data.username}:</b> ${data.message}`;
        chatLog.prepend(messageElement);
    }
};

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ WebSocket
document.querySelector('#chat-message-submit').onclick = function () {
    const messageInputDom = document.querySelector('#chat-message-input');
    const message = messageInputDom.value;

    chatSocket.send(JSON.stringify({
        'username': username,
        'message': message
    }));

    messageInputDom.value = '';
};

// –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —á–∞—Ç–∞
document.querySelector('#end-chat').onclick = function () {
    window.location.href = "{% url 'ads_list' 'all' %}";
};

// –û–±—Ä–∞–±–æ—Ç–∫–∞ SDP
async function handleSDP(sdp) {
    try {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(sdp));
        if (sdp.type === 'offer') {
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            chatSocket.send(JSON.stringify({
                'sdp': answer,
                'username': username
            }));
        }
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ SDP:", error);
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ ICE-–∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
async function handleICE(ice) {
    try {
        await peerConnection.addIceCandidate(new RTCIceCandidate(ice));
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ICE-–∫–∞–Ω–¥–∏–¥–∞—Ç–∞:", error);
    }
}

// –ó–∞–ø—É—Å–∫ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –≤–∏–¥–µ–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
startLocalVideo();

</script>

{% endblock %}
