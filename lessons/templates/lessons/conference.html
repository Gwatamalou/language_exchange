{% extends 'base.html' %}

{% block content %}

<div class="container d-flex flex-column align-items-center justify-content-center vh-100 my-5">
    <!-- Ð’Ð¸Ð´ÐµÐ¾ ÑÐ¾Ð±ÐµÑÐµÐ´Ð½Ð¸ÐºÐ° -->
    <div class="position-relative mb-4" style="width: 100%; max-width: 800px; aspect-ratio: 16/9; background-color: #999999; border-radius: 10px; overflow: hidden;">
        <video id="remoteVideo" autoplay style="width: 100%; height: 100%; object-fit: cover;"></video>

        <!-- Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð²Ð¸Ð´ÐµÐ¾ -->
        <div class="position-absolute bottom-0 start-0 p-2">
            <video id="localVideo" autoplay muted class="rounded-circle border" style="width: 100px; height: 100px; object-fit: cover; background: #53B3FF;"></video>
        </div>

        <!-- ÐšÐ½Ð¾Ð¿ÐºÐ° "Ð—Ð°ÐºÐ¾Ð½Ñ‡Ð¸Ñ‚ÑŒ" -->
        <button id="end-chat" class="btn btn-danger rounded-circle position-absolute bottom-0 end-0 m-3" style="width: 50px; height: 50px;">
            &#10005;
        </button>

        <!-- ÐšÐ½Ð¾Ð¿ÐºÐ¸ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð²Ð¸Ð´ÐµÐ¾ Ð¸ Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½Ð¾Ð¼ -->
        <div class="d-flex justify-content-center position-absolute bottom-0 start-50 translate-middle-x mb-3">
            <button id="toggle-video" class="btn btn-secondary rounded-circle me-3" style="width: 50px; height: 50px;">
                ðŸŽ¥
            </button>
            <button id="toggle-audio" class="btn btn-secondary rounded-circle" style="width: 50px; height: 50px;">
                ðŸŽ¤
            </button>
        </div>
    </div>

    <!-- Ð§Ð°Ñ‚ -->
    <div class="chat-container bg-light border rounded p-3" style="width: 100%; max-width: 600px; height: 300px; overflow-y: auto; display: flex; flex-direction: column-reverse;">
        <div id="chat-log" class="chat-log">
            <!-- Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ñ‡Ð°Ñ‚Ð° Ð±ÑƒÐ´ÑƒÑ‚ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÑ‚ÑŒÑÑ ÑÑŽÐ´Ð° -->
        </div>
    </div>

    <!-- ÐŸÐ¾Ð»Ñ Ð²Ð²Ð¾Ð´Ð° Ð¸ ÐºÐ½Ð¾Ð¿ÐºÐ° "ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ" -->
    <div class="d-flex mt-3" style="width: 100%; max-width: 600px;">
        <input id="chat-message-input" type="text" class="form-control me-2" placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ">
        <button id="chat-message-submit" class="btn btn-primary">ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ</button>
    </div>
</div>

<script>
    const roomName = "{{ room_name }}";
    const username = "{{ request.user.username }}";
    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/' + roomName + '/');

    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const toggleVideoButton = document.getElementById('toggle-video');
    const toggleAudioButton = document.getElementById('toggle-audio');
    let localStream;

    // ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ WebRTC
    let peerConnection;
    const configuration = {
        iceServers: [{urls: 'stun:stun.l.google.com:19302'}]
    };

    async function startLocalVideo() {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
            localVideo.srcObject = localStream;

            // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ PeerConnection, ÐºÐ¾Ð³Ð´Ð° Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿Ð¾Ñ‚Ð¾Ðº Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½
            createPeerConnection();
        } catch (error) {
            console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº Ð¼ÐµÐ´Ð¸Ð°-ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°Ð¼.", error);
        }
    }

    function createPeerConnection() {
        peerConnection = new RTCPeerConnection(configuration);

        // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ñ‚Ñ€ÐµÐºÐ¸ Ð² PeerConnection
        localStream.getTracks().forEach(track => {
            peerConnection.addTrack(track, localStream);
        });

        // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð¿Ð¾Ñ‚Ð¾ÐºÐ°
        peerConnection.ontrack = (event) => {
            remoteVideo.srcObject = event.streams[0];
        };

        // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ICE-ÐºÐ°Ð½Ð´Ð¸Ð´Ð°Ñ‚Ð¾Ð²
        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                chatSocket.send(JSON.stringify({
                    'ice': event.candidate,
                    'username': username
                }));
            }
        };
    }

    toggleVideoButton.onclick = () => {
        const videoTrack = localStream.getVideoTracks()[0];
        videoTrack.enabled = !videoTrack.enabled;
        toggleVideoButton.classList.toggle('btn-danger');
    };

    toggleAudioButton.onclick = () => {
        const audioTrack = localStream.getAudioTracks()[0];
        audioTrack.enabled = !audioTrack.enabled;
        toggleAudioButton.classList.toggle('btn-danger');
    };

    chatSocket.onmessage = async function (e) {
        const data = JSON.parse(e.data);
        const chatLog = document.querySelector('#chat-log');
        const messageElement = document.createElement('div');

        messageElement.className = data.username === username ? 'text-end text-primary' : 'text-start text-secondary';
        messageElement.innerHTML = `<b>${data.username}:</b> ${data.message}`;
        chatLog.prepend(messageElement);

        if (data.sdp) {
            await handleSDP(data.sdp);
        } else if (data.ice) {
            await handleICE(data.ice);
        }
    };

    document.querySelector('#chat-message-submit').onclick = function () {
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;

        chatSocket.send(JSON.stringify({
            'username': username,
            'message': message
        }));

        messageInputDom.value = '';
    };

    document.querySelector('#end-chat').onclick = function () {
        window.location.href = "{% url 'ads_list' 'all'%}";
    };

    startLocalVideo();

    async function handleSDP(sdp) {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(sdp));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        chatSocket.send(JSON.stringify({
            'sdp': answer,
            'username': username
        }));
    }

    async function handleICE(ice) {
        await peerConnection.addIceCandidate(new RTCIceCandidate(ice));
    }
</script>

{% endblock %}
